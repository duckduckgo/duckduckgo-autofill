name: Update Screenshots on a PR
description: |
    Runs screenshot tests and commits updated screenshots to a PR.

    Your PR will receive a commit with the changes so you can manually verify before merging.

on:
    workflow_dispatch:
        inputs:
            pr_number:
                description: 'Pull Request Number (Warning: This action will push a commit to the referenced PR)'
                required: true
                type: number

permissions:
    pull-requests: write
    contents: write

jobs:
    update-pr-with-screenshots:
        name: Update PR With Screenshots
        runs-on: macos-14
        steps:
            - uses: actions/checkout@v4
            - name: Checkout PR ${{ github.event.inputs.pr_number }}
              if: github.event_name == 'workflow_dispatch'
              run: gh pr checkout ${{ github.event.inputs.pr_number }}
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version-file: '.nvmrc'
            - uses: actions/cache@v4
              with:
                  path: |
                      ~/.npm
                      ~/.cache/ms-playwright
                  key: ${{ runner.os }}-node-playwright-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-playwright-
                      ${{ runner.os }}-node-
            - name: Install dependencies
              run: npm ci
            - name: Install Playwright Browsers
              run: npx playwright install --with-deps
            - name: Run screenshot tests
              id: screenshot_tests
              continue-on-error: true
              run: npm run test:screenshots
            - name: Check if tests passed
              if: steps.screenshot_tests.outcome == 'success'
              run: echo "Nothing to update - tests all passed"
            - name: Update screenshots
              id: screenshot_tests_update
              if: steps.screenshot_tests.outcome == 'failure'
              run: npm run test:screenshots:update
            - name: Commit the updated files to the PR branch
              if: steps.screenshot_tests.outcome == 'failure' && steps.screenshot_tests_update.outcome == 'success'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add "*.png"
                  git commit -m "Updated screenshots via workflow"
                  git push origin HEAD
