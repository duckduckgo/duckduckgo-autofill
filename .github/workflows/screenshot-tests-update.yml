# Update Screenshots on a PR
#
# Runs previously failed screenshot tests, and commits the changes.
# Your PR will receive a commit with the changes so you can manually verify before merging.

name: Update Screenshots on a PR

on:
    workflow_dispatch:
        inputs:
            pr_number:
                description: 'Pull Request Number (Warning: This action will push a commit to the referenced PR)'
                required: true
                type: number

permissions:
    pull-requests: write
    contents: write

jobs:
    update-pr-with-screenshots:
        name: Update PR With Screenshots
        runs-on: macos-14
        steps:
            - uses: actions/checkout@v4

            - name: Checkout PR ${{ github.event.inputs.pr_number }}
              if: github.event_name == 'workflow_dispatch'
              run: gh pr checkout ${{ github.event.inputs.pr_number }}
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version-file: '.nvmrc'

            - uses: actions/cache@v4
              with:
                  path: |
                      ~/.npm
                      ~/.cache/ms-playwright
                  key: ${{ runner.os }}-node-playwright-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-playwright-
                      ${{ runner.os }}-node-

            - name: Install dependencies
              run: npm ci

            - name: Install Playwright Browsers
              run: npx playwright install --with-deps chromium

            - name: Run screenshot tests
              id: screenshot_tests
              run: npm run test:screenshots

            - if: ${{ steps.screenshot_tests.conclusion == 'success' }}
              run: |
                  echo "Nothing to update - tests all passed"

            - name: Re-run Playwright to update screenshots
              id: screenshot_tests_update
              if: ${{ failure() && steps.screenshot_tests.conclusion == 'failure' }}
              run: npm run test:screenshots:update

            - name: Commit updated screenshots to the PR branch
              if: ${{ failure() && steps.screenshot_tests_update.conclusion == 'success' }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # Configure Git with a bot's username and email for committing changes
                  # This makes it easy to identify in the PR
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # Stage all updated PNG files for commit
                  git add "*.png"

                  # Commit the changes with a descriptive message
                  git commit -m "Update screenshots via workflow"

                  # Push the changes to the current branch in the PR
                  git push origin HEAD
